<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tea Processing — Firestore Save + GitHub Pages</title>
<style>
  :root{--accent:#286ef0;--muted:#6c757d}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:1100px; margin:20px auto; padding:18px; color:#111}
  h1{font-size:1.5rem;margin:0 0 8px}
  h2{font-size:1.1rem;margin:14px 0 8px}
  form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;background:#fbfbfb;padding:14px;border-radius:8px;border:1px solid #e6e6e6}
  label{display:block;margin-bottom:6px;font-weight:600;font-size:0.95rem}
  input,select,textarea,button{width:100%;padding:8px;border-radius:6px;border:1px solid #cfcfcf;font-size:0.95rem;box-sizing:border-box}
  textarea{min-height:80px}
  .full{grid-column:1/-1}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{cursor:pointer;background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px}
  button.secondary{background:var(--muted);}
  .note{font-size:0.9rem;color:#444;margin-bottom:8px}
  .withering-entry{border:1px dashed #999;padding:10px;border-radius:8px;background:#fff;margin-bottom:10px}
  .deleteBtn{background:#d9534f;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer}
  #witheringContainer{margin-top:8px}
  #recordsList{margin-top:12px}
  .record{background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:10px}
  pre{white-space:pre-wrap;word-break:break-word;background:#f6f8fa;padding:8px;border-radius:6px}
  @media (max-width:820px){ form{grid-template-columns:1fr} }
  .small{font-size:0.9rem;color:#333}
  table.summary{width:100%;border-collapse:collapse;margin-top:8px}
  table.summary th, table.summary td{padding:8px;border:1px solid #ccc;text-align:left}
</style>
</head>
<body>

<h1>Tea Processing — Save to Firestore & Export</h1>
<p class="note">This page saves records to Cloud Firestore (online). Use <strong>Save Record</strong> to store a record; the latest saved record is used by Export CSV / Export Word buttons.</p>

<form id="entryForm" onsubmit="return false;">
  <div>
    <label>Main plucking date <span class="small">(required)</span></label>
    <input type="date" id="pluckingDate" required>
  </div>

  <div>
    <label>Green leaf from (location / Field No)</label>
    <input type="text" id="greenLeafFrom" placeholder="Field / Location">
  </div>

  <!-- Withering entries -->
  <div class="full">
    <h2>Withering Entries (multiple)</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button id="addWitheringBtn" type="button">➕ Add Withering Entry</button>
      <button id="clearWitheringBtn" type="button" class="secondary">Clear Withering Entries</button>
      <div class="small" style="margin-left:8px">Note: <strong>Start trough</strong> only; End trough is not required.</div>
    </div>
    <div id="witheringContainer"></div>
  </div>

  <h2 class="full">Manufacture / Rolling / Fermentation / Dryer / Firing / Notes</h2>

  <div>
    <label>Manufacture start</label>
    <input type="datetime-local" id="manufactureStart">
  </div>

  <div>
    <label>Green leaf weight (GL)</label>
    <input type="number" id="gl" step="any">
  </div>

  <div>
    <label>Withered leaf weight (WL)</label>
    <input type="number" id="wl" step="any">
  </div>

  <div>
    <label>Withered leaf % (WL%)</label>
    <input type="text" id="wlPercent">
  </div>

  <div>
    <label>Made Tea (MT)</label>
    <input type="text" id="mt" placeholder="Made tea">
  </div>

  <div>
    <label>Outturn % (OT)</label>
    <input type="text" id="ot" placeholder="Outturn">
  </div>

  <div>
    <label>Trough nos</label>
    <input type="text" id="troughNos" placeholder="e.g. 5,6">
  </div>

  <div>
    <label>Trough RPM</label>
    <select id="troughRPM"></select>
  </div>

  <div>
    <label>Roller RPM</label>
    <input type="number" id="rollerRPM">
  </div>

  <div>
    <label>Roll time (minutes)</label>
    <input type="number" id="rollTime">
  </div>

  <div>
    <label>Roller no</label>
    <input type="text" id="rollerNo">
  </div>

  <div>
    <label>Fermentation time (HH:MM)</label>
    <input type="time" id="fermentationTime">
  </div>

  <div>
    <label>Fermentation type</label>
    <input type="text" id="fermentationType" placeholder="FLOOR">
  </div>

  <div>
    <label>Dryer start</label>
    <input type="datetime-local" id="dryerStart">
  </div>

  <div>
    <label>Dryer circuit time (minutes)</label>
    <input type="number" id="dryerCircuit">
  </div>

  <div>
    <label>Dryer name</label>
    <select id="dryerName">
      <option value="BRITANNIA">BRITANNIA</option>
      <option value="DRYOTEA">DRYOTEA</option>
    </select>
  </div>

  <div>
    <label>Inlet temp (°C)</label>
    <input type="number" id="inletTemp" step="any">
  </div>

  <div>
    <label>Exhaust temp (°C)</label>
    <input type="number" id="exhaustTemp" step="any">
  </div>

  <div>
    <label>Dryer Mouth Temp / Moisture</label>
    <input type="text" id="mouthTemp">
  </div>

  <div>
    <label>Firing start (HH:MM)</label>
    <input type="time" id="firingStart">
  </div>

  <div>
    <label>Firing end (HH:MM)</label>
    <input type="time" id="firingEnd">
  </div>

  <div class="full">
    <label>General notes</label>
    <textarea id="notes"></textarea>
  </div>

  <div class="controls full">
    <button id="saveBtn" type="button">Save Record (online)</button>
    <button id="fetchLatestBtn" type="button" class="secondary">Fetch Latest Record</button>
    <button id="exportCSVBtn" type="button" class="secondary">Export CSV (latest)</button>
    <button id="exportWordBtn" type="button" class="secondary">Export Word (latest)</button>
    <button id="clearUIBtn" type="button" class="secondary">Clear Form</button>
  </div>
</form>

<hr>

<h2>Latest Saved Record (from Firestore)</h2>
<div id="recordsList"><em>Not loaded yet.</em></div>

<!-- Firebase modular SDK (CDN) -->
<script type="module">
  // --- 1) Replace the config object below with your Firebase web app config ----
  // Get this from Firebase Console > Project settings > Your apps (Web)
  const firebaseConfig = {
    /* FIREBASE CONFIG HERE
       Example:
       apiKey: "xxx",
       authDomain: "project-id.firebaseapp.com",
       projectId: "project-id",
       storageBucket: "project-id.appspot.com",
       messagingSenderId: "1234567890",
       appId: "1:123:web:abcd",
    */
  };

  // --- 2) Import modular SDK from CDN ---
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

  // Initialize Firebase & Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const recordsCol = collection(db, 'tea_records');

  // --- UI helpers & form logic (almost same as your original) ---
  const recordsList = document.getElementById('recordsList');
  const witheringContainer = document.getElementById('witheringContainer');
  const troughRPM = document.getElementById('troughRPM');
  for (let i = 100; i <= 1400; i += 100) troughRPM.add(new Option(i, i));
  let witheringIndex = 0;

  function createWitheringEntry(idx){
    const d = document.createElement('div');
    d.className = 'withering-entry';
    d.dataset.idx = idx;
    d.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Withering Entry ${idx}</strong>
        <button class="deleteBtn" type="button">Delete</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <div>
          <label>Start Date & Time</label>
          <input type="datetime-local" class="w-start">
        </div>
        <div>
          <label>Start Trough</label>
          <select class="w-trough"></select>
        </div>
        <div>
          <label>End Date & Time</label>
          <input type="datetime-local" class="w-end">
        </div>
        <div>
          <label>Total Hours (auto)</label>
          <input type="text" class="w-total" readonly>
        </div>
      </div>
    `;
    const sel = d.querySelector('.w-trough');
    for (let t = 1; t <= 24; t++) sel.add(new Option(t, t));
    d.querySelector('.deleteBtn').addEventListener('click', ()=> d.remove());

    const startInput = d.querySelector('.w-start');
    const endInput = d.querySelector('.w-end');
    const totalInput = d.querySelector('.w-total');
    function calcHours(){
      const s = startInput.value, e = endInput.value;
      if(!s || !e){ totalInput.value = ''; return; }
      const diff = (new Date(e) - new Date(s)) / (1000*60*60);
      totalInput.value = isFinite(diff) ? (diff >= 0 ? diff.toFixed(2) : 'Invalid') : '';
    }
    startInput.addEventListener('change', calcHours);
    endInput.addEventListener('change', calcHours);
    return d;
  }

  document.getElementById('addWitheringBtn').addEventListener('click', ()=>{
    witheringIndex++;
    witheringContainer.appendChild(createWitheringEntry(witheringIndex));
  });

  document.getElementById('clearWitheringBtn').addEventListener('click', ()=>{
    if(!confirm('Clear all withering entries?')) return;
    witheringContainer.innerHTML = '';
    witheringIndex = 0;
  });

  function buildRecordObject(){
    const ft = document.getElementById('fermentationTime').value;
    let fermentationMinutes = '';
    if(ft){
      const pieces = ft.split(':').map(x=>Number(x||0));
      fermentationMinutes = pieces[0]*60 + pieces[1];
    }
    const wdivs = witheringContainer.querySelectorAll('.withering-entry');
    const withering = [];
    wdivs.forEach(div=>{
      withering.push({
        start: div.querySelector('.w-start').value || '',
        startTrough: div.querySelector('.w-trough').value || '',
        end: div.querySelector('.w-end').value || '',
        hours: div.querySelector('.w-total').value || ''
      });
    });

    const rec = {
      mainPluckingDate: (document.getElementById('pluckingDate').value || '').toString(),
      greenLeafFrom: (document.getElementById('greenLeafFrom').value || '').toString(),
      withering,
      manufactureStart: (document.getElementById('manufactureStart').value || '').toString(),
      gl: (document.getElementById('gl').value || '').toString(),
      wl: (document.getElementById('wl').value || '').toString(),
      wlPercent: (document.getElementById('wlPercent').value || '').toString(),
      mt: (document.getElementById('mt').value || '').toString(),
      ot: (document.getElementById('ot').value || '').toString(),
      troughNos: (document.getElementById('troughNos').value || '').toString(),
      troughRPM: (document.getElementById('troughRPM').value || '').toString(),
      rollerRPM: (document.getElementById('rollerRPM').value || '').toString(),
      rollTime: (document.getElementById('rollTime').value || '').toString(),
      rollerNo: (document.getElementById('rollerNo').value || '').toString(),
      fermentationTimeMinutes: fermentationMinutes,
      fermentationType: (document.getElementById('fermentationType').value || '').toString(),
      dryerStart: (document.getElementById('dryerStart').value || '').toString(),
      dryerCircuit: (document.getElementById('dryerCircuit').value || '').toString(),
      dryerName: (document.getElementById('dryerName').value || '').toString(),
      inletTemp: (document.getElementById('inletTemp').value || '').toString(),
      exhaustTemp: (document.getElementById('exhaustTemp').value || '').toString(),
      mouthTemp: (document.getElementById('mouthTemp').value || '').toString(),
      firingStart: (document.getElementById('firingStart').value || '').toString(),
      firingEnd: (document.getElementById('firingEnd').value || '').toString(),
      notes: (document.getElementById('notes').value || '').toString(),
      createdAt: serverTimestamp()
    };
    return rec;
  }

  // Save to Firestore
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const rec = buildRecordObject();
    if(!rec.mainPluckingDate){
      alert('Please provide Main plucking date (required).'); return;
    }
    try {
      const docRef = await addDoc(recordsCol, rec);
      alert('Record saved online. ID: ' + docRef.id);
      // show latest
      await fetchLatestRecord();
      // clear form
      document.getElementById('entryForm').reset();
      witheringContainer.innerHTML = '';
      witheringIndex = 0;
    } catch (err) {
      console.error(err);
      alert('Save failed: ' + (err.message || err));
    }
  });

  // Fetch latest (by createdAt timestamp) and render
  async function fetchLatestRecord(){
    recordsList.innerHTML = '<em>Loading latest record…</em>';
    try {
      const q = query(recordsCol, orderBy('createdAt', 'desc'), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) {
        recordsList.innerHTML = '<em>No records found in Firestore.</em>';
        return;
      }
      const doc = snap.docs[0];
      const r = doc.data();
      // createdAt might be a Firestore timestamp; display safely
      const createdAt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : (r.createdAt || '');
      let html = `<div class="record"><strong>Latest — ${escapeHtml(r.mainPluckingDate || 'no-date')}</strong>
      <div style="margin-top:8px">
        <table class="summary">
          <tr><th>Main plucking date</th><td>${escapeHtml(r.mainPluckingDate)}</td></tr>
          <tr><th>Green leaf from</th><td>${escapeHtml(r.greenLeafFrom)}</td></tr>
          <tr><th>Withering entries</th><td>${r.withering ? r.withering.length + ' entries' : 0}</td></tr>
          <tr><th>Manufacture start</th><td>${escapeHtml(r.manufactureStart)}</td></tr>
          <tr><th>GL / WL / WL%</th><td>${escapeHtml(r.gl)} / ${escapeHtml(r.wl)} / ${escapeHtml(r.wlPercent)}</td></tr>
          <tr><th>Made Tea (MT) / Outturn (OT)</th><td>${escapeHtml(r.mt)} / ${escapeHtml(r.ot)}</td></tr>
          <tr><th>Notes</th><td>${escapeHtml(r.notes)}</td></tr>
          <tr><th>Saved at</th><td>${escapeHtml(createdAt)}</td></tr>
        </table>
      </div></div>`;
      recordsList.innerHTML = html;
      // store latest in window.latestRecord for export buttons
      window.latestRecord = r;
    } catch (err) {
      console.error(err);
      recordsList.innerHTML = '<em>Failed to load latest record: '+ escapeHtml(err.message || err) +'</em>';
    }
  }

  document.getElementById('fetchLatestBtn').addEventListener('click', fetchLatestRecord);
  // Load latest on page open
  fetchLatestRecord();

  // Export CSV / Word operate on window.latestRecord (from Firestore)
  function csvEscape(v){
    if (v == null) return '';
    const s = v.toString();
    if (/["\r\n,]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function escapeHtml(s){
    if(s == null) return '';
    return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  document.getElementById('exportCSVBtn').addEventListener('click', ()=>{
    const r = window.latestRecord;
    if(!r){ alert('No latest record loaded. Click Fetch Latest Record first.'); return; }
    const header = [
      "MainPluckingDate","GreenLeafFrom","WitheringEntries",
      "ManufactureStart","GL","WL","WL%","MadeTea_MT","Outturn_OT",
      "TroughNos","TroughRPM","RollerRPM","RollTime","RollerNo",
      "FermentationMinutes","FermentationType",
      "DryerStart","DryerCircuit","DryerName","InletTemp","ExhaustTemp","MouthTemp",
      "FiringStart","FiringEnd","Notes","CreatedAt"
    ];
    const withString = (r.withering && r.withering.length)
      ? r.withering.map((w,i)=>`#${i+1}|S:${w.start||''}|T:${w.startTrough||''}|E:${w.end||''}|H:${w.hours||''}`).join(' ; ')
      : '';
    const row = [
      r.mainPluckingDate, r.greenLeafFrom, withString,
      r.manufactureStart, r.gl, r.wl, r.wlPercent, r.mt, r.ot,
      r.troughNos, r.troughRPM, r.rollerRPM, r.rollTime, r.rollerNo,
      r.fermentationTimeMinutes, r.fermentationType,
      r.dryerStart, r.dryerCircuit, r.dryerName, r.inletTemp, r.exhaustTemp, r.mouthTemp,
      r.firingStart, r.firingEnd, r.notes, (r.createdAt && r.createdAt.toDate) ? r.createdAt.toDate().toISOString() : (r.createdAt||'')
    ];
    const csv = [header.map(csvEscape).join(','), row.map(csvEscape).join(',')].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeDate = (r.mainPluckingDate || 'no-date').replace(/[:\/\\ ]/g,'_');
    a.download = `tea_processing_${safeDate}_latest.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  document.getElementById('exportWordBtn').addEventListener('click', ()=>{
    const r = window.latestRecord;
    if(!r){ alert('No latest record loaded. Click Fetch Latest Record first.'); return; }
    const title = `Tea Processing Record - ${r.mainPluckingDate}`;
    let doc = '<!doctype html><html><head><meta charset="utf-8"><title>' + escapeHtml(title) + '</title>';
    doc += `<style>
      body{font-family:Calibri, "Times New Roman", serif; padding:24px; color:#111}
      h1{font-size:20pt; text-align:center; font-weight:700; margin-bottom:8px}
      h2{font-size:14pt; margin-top:18px; margin-bottom:6px; font-weight:700}
      table{width:100%; border-collapse:collapse; margin-top:6px}
      th,td{border:1px solid #444; padding:8px; vertical-align:top}
      th{background:#f3f3f3; font-weight:700}
      .small{font-size:10pt; color:#333}
      .section{margin-bottom:12px}
    </style></head><body>`;
    doc += `<h1>Frost Tea Processing Report</h1>`;
    doc += `<div style="text-align:center;margin-bottom:12px"><span class="small">Generated: ${escapeHtml(new Date().toLocaleString())}</span></div>`;
    doc += `<h2>General Information</h2><table><tr><th>Main Plucking Date</th><td>${escapeHtml(r.mainPluckingDate)}</td></tr>`;
    doc += `<tr><th>Green Leaf From</th><td>${escapeHtml(r.greenLeafFrom)}</td></tr>`;
    doc += `<tr><th>Created At</th><td>${escapeHtml((r.createdAt && r.createdAt.toDate) ? r.createdAt.toDate().toLocaleString() : (r.createdAt||''))}</td></tr>`;
    doc += `</table>`;
    doc += `<h2>Manufacture & Measurements</h2>`;
    doc += `<table>
      <tr><th>Manufacture Start</th><td>${escapeHtml(r.manufactureStart)}</td></tr>
      <tr><th>GL</th><td>${escapeHtml(r.gl)}</td></tr>
      <tr><th>WL</th><td>${escapeHtml(r.wl)}</td></tr>
      <tr><th>WL %</th><td>${escapeHtml(r.wlPercent)}</td></tr>
      <tr><th>Made Tea (MT)</th><td>${escapeHtml(r.mt)}</td></tr>
      <tr><th>Outturn % (OT)</th><td>${escapeHtml(r.ot)}</td></tr>
    </table>`;
    doc += `<h2>Rolling & Fermentation</h2>`;
    doc += `<table>
      <tr><th>Trough Nos</th><td>${escapeHtml(r.troughNos)}</td></tr>
      <tr><th>Trough RPM</th><td>${escapeHtml(r.troughRPM)}</td></tr>
      <tr><th>Roller RPM</th><td>${escapeHtml(r.rollerRPM)}</td></tr>
      <tr><th>Roll Time (min)</th><td>${escapeHtml(r.rollTime)}</td></tr>
      <tr><th>Roller No</th><td>${escapeHtml(r.rollerNo)}</td></tr>
      <tr><th>Fermentation Time (minutes)</th><td>${escapeHtml(r.fermentationTimeMinutes)}</td></tr>
      <tr><th>Fermentation Type</th><td>${escapeHtml(r.fermentationType)}</td></tr>
    </table>`;
    doc += `<h2>Dryer & Firing</h2>`;
    doc += `<table>
      <tr><th>Dryer Start</th><td>${escapeHtml(r.dryerStart)}</td></tr>
      <tr><th>Dryer Circuit (min)</th><td>${escapeHtml(r.dryerCircuit)}</td></tr>
      <tr><th>Dryer Name</th><td>${escapeHtml(r.dryerName)}</td></tr>
      <tr><th>Inlet Temp (°C)</th><td>${escapeHtml(r.inletTemp)}</td></tr>
      <tr><th>Exhaust Temp (°C)</th><td>${escapeHtml(r.exhaustTemp)}</td></tr>
      <tr><th>Dryer Mouth Temp / Moisture</th><td>${escapeHtml(r.mouthTemp)}</td></tr>
      <tr><th>Firing Start</th><td>${escapeHtml(r.firingStart)}</td></tr>
      <tr><th>Firing End</th><td>${escapeHtml(r.firingEnd)}</td></tr>
    </table>`;
    doc += `<h2>Withering Entries</h2>`;
    if(r.withering && r.withering.length){
      doc += `<table><tr><th>S.No</th><th>Start Date & Time</th><th>Start Trough</th><th>End Date & Time</th><th>Total Hours</th></tr>`;
      r.withering.forEach((w, i)=>{
        doc += `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(w.start)}</td>
          <td>${escapeHtml(w.startTrough)}</td>
          <td>${escapeHtml(w.end)}</td>
          <td>${escapeHtml(w.hours)}</td>
        </tr>`;
      });
      doc += `</table>`;
    } else {
      doc += `<p class="small">(No withering entries recorded)</p>`;
    }
    doc += `<h2>Notes</h2><div style="border:1px solid #ccc;padding:10px;border-radius:6px">${escapeHtml(r.notes)}</div>`;
    doc += `</body></html>`;
    const blob = new Blob(['\ufeff' + doc], { type: 'application/vnd.ms-word;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeDate = (r.mainPluckingDate || 'no-date').replace(/[:\/\\ ]/g,'_');
    a.download = `tea_processing_${safeDate}_latest.doc`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  document.getElementById('clearUIBtn').addEventListener('click', ()=>{
    if(!confirm('Clear form?')) return;
    document.getElementById('entryForm').reset();
    witheringContainer.innerHTML = '';
    witheringIndex = 0;
  });
</script>
</body>
</html>
